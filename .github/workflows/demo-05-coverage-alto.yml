# Demo 05 - Coverage Alto (80%)
# Aqu√≠ la mayor√≠a de proyectos fallan - Es el objetivo

name: Demo 05 - Coverage 80%

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

env:
  COVERAGE_THRESHOLD: 80

jobs:
  coverage-alto:
    name: "Coverage Alto (80%)"
    runs-on: ubuntu-latest
    
    steps:
    # 1. Setup b√°sico
    - name: Obtener c√≥digo
      uses: actions/checkout@v4
    
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Instalar dependencias
      run: npm ci
    
    # 2. Ejecutar tests con coverage
    - name: Ejecutar tests con coverage
      run: |
        echo "Generando reporte de coverage..."
        echo "Umbral configurado: ${{ env.COVERAGE_THRESHOLD }}% (ALTO)"
        npm run test:coverage
    
    # 3. An√°lisis del coverage (alto - la mayor√≠a falla)
    - name: "Gate de Coverage - Verificaci√≥n Real"
      run: |
        echo "MOMENTO DE LA VERDAD:"
        echo ""
        echo "Extrayendo porcentaje real de coverage..."
        
        # M√âTODO 1: Usar Jest con formato JSON para precisi√≥n
        echo "Ejecutando tests con coverage en formato JSON..."
        npm run test:coverage -- --coverageReporters=json-summary --silent
        
        # Leer el archivo de coverage JSON
        if [ -f coverage/coverage-summary.json ]; then
          COVERAGE_PERCENT=$(node -p "Math.floor(JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct)")
          echo " Coverage extra√≠do del reporte JSON: $COVERAGE_PERCENT%"
        else
          # M√âTODO 2: Fallback - extraer del output de Jest
          echo "  Archivo JSON no encontrado, usando m√©todo alternativo..."
          COVERAGE_OUTPUT=$(npm run test:coverage 2>&1)
          COVERAGE_PERCENT=$(echo "$COVERAGE_OUTPUT" | grep -oE 'All files[^|]*\|[^|]*\|[^|]*\|[^|]*\|[[:space:]]*[0-9]+(\.[0-9]+)?' | grep -oE '[0-9]+(\.[0-9]+)?$' | head -1)
          COVERAGE_PERCENT=${COVERAGE_PERCENT%.*}  # Remover decimales
          echo "Coverage extra√≠do del output: $COVERAGE_PERCENT%"
        fi
        
        # Validar que tenemos un n√∫mero
        if ! [[ "$COVERAGE_PERCENT" =~ ^[0-9]+$ ]]; then
          echo " Error: No se pudo extraer el coverage"
          echo "Output de coverage:"
          npm run test:coverage
          exit 1
        fi
        
        THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
        
        echo ""
        echo " Coverage objetivo: $THRESHOLD%"
        echo " Coverage actual: $COVERAGE_PERCENT%"
        echo ""
        
        # VALIDACI√ìN REAL: Fallar si no alcanza el umbral
        if [ "$COVERAGE_PERCENT" -lt "$THRESHOLD" ]; then
          echo "‚ùå COVERAGE INSUFICIENTE"
          echo "   Necesitas: $THRESHOLD%"
          echo "   Tienes: $COVERAGE_PERCENT%"
          echo "   Faltante: $((THRESHOLD - COVERAGE_PERCENT))%"
          echo ""
          echo "üö® EL PIPELINE FALLAR√Å AQU√ç üö®"
          echo "Esto es REAL - necesitas m√°s tests"
          echo ""
          echo "Para alcanzar $THRESHOLD% necesitas probar:"
          echo "   ‚úì Todos los endpoints principales"
          echo "   ‚úì Casos de √©xito Y casos de error"  
          echo "   ‚úì Validaciones y edge cases"
          echo "   ‚úì Manejo de errores"
          exit 1
        else
          echo "COVERAGE EXCELENTE"
          echo "   Objetivo: $THRESHOLD%"
          echo "   Actual: $COVERAGE_PERCENT%"
          echo "   Exceso: +$((COVERAGE_PERCENT - THRESHOLD))%"
          echo "   ¬°Felicitaciones! "
        fi
    
    # 4. Verificaci√≥n real con posible fallo
    - name: "Gate de Coverage - Verificaci√≥n Real"
      run: |
        echo "MOMENTO DE LA VERDAD:"
        echo ""
        echo "Extrayendo porcentaje real de coverage..."
        
        # Intentar extraer el coverage real (esto puede fallar y est√° bien)
        echo "Si este step falla, es normal y educativo"
        echo "Significa que tu proyecto necesita m√°s tests"
        echo ""
        echo "Para alcanzar 80% necesitas probar:"
        echo "   Todos los endpoints principales"
        echo "   Casos de √©xito Y casos de error"  
        echo "   Validaciones y edge cases"
        echo "   Manejo de errores"
        echo ""
        echo "Si fallas aqu√≠: PERFECTO"
        echo "   Es una oportunidad de aprender"
        echo "   Te motiva a escribir mejores tests"
        echo "   Cuando lo logres, tendr√°s un proyecto robusto"
    
    # 5. Lecci√≥n final (se ejecuta aunque falle)
    - name: "Lecci√≥n Final: El Valor del Coverage Alto"
      if: always()
      run: |
        echo "LECCI√ìN FINAL - EL VALOR DEL COVERAGE ALTO:"
        echo ""
        echo "¬øPor qu√© 80% es mejor que 30%?"
        echo ""
        echo "Con 30% coverage:"
        echo "   70% del c√≥digo sin probar"
        echo "   Muchos bugs pueden pasar desapercibidos"
        echo "   Desplegar da miedo"
        echo ""
        echo "Con 80% coverage:"
        echo "   Solo 20% del c√≥digo sin probar"
        echo "   La mayor√≠a de bugs se detectan"
        echo "   Puedes desplegar con confianza"
        echo ""
        echo "El coverage no es solo un n√∫mero:"
        echo "   Es confianza en tu c√≥digo"
        echo "   Es calidad en tu proyecto"
        echo "   Es profesionalismo en desarrollo"
        echo ""
        echo "META PARA PROYECTOS:"
        echo "   M√≠nimo aceptable: 60%"
        echo "   Bueno: 70%"
        echo "   Excelente: 80%+"
        echo ""
        echo "Ahora ve y mejora el coverage de tu proyecto"
